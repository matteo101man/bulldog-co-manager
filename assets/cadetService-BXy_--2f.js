var j=Object.defineProperty;var q=(o,t,e)=>t in o?j(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var T=(o,t,e)=>q(o,typeof t!="symbol"?t+"":t,e);import{q as E,d as m,w as y,k as I,j as N,l as P,f as S,u as x,m as M,c as R}from"./firebase-vendor-u2jlvS72.js";import{d as u}from"./index-DKB6D4ej.js";const _="ROTC_Cache",D=1,c={CADETS:"cadets",ATTENDANCE:"attendance",TRAINING_EVENTS:"trainingEvents",METADATA:"metadata"};class O{constructor(){T(this,"db",null);T(this,"initPromise",null)}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((t,e)=>{const r=indexedDB.open(_,D);r.onerror=()=>{console.error("Failed to open IndexedDB:",r.error),e(r.error)},r.onsuccess=()=>{this.db=r.result,t()},r.onupgradeneeded=a=>{const n=a.target.result;if(n.objectStoreNames.contains(c.CADETS)||n.createObjectStore(c.CADETS,{keyPath:"id"}).createIndex("company","company",{unique:!1}),!n.objectStoreNames.contains(c.ATTENDANCE)){const s=n.createObjectStore(c.ATTENDANCE,{keyPath:"id"});s.createIndex("weekStartDate","weekStartDate",{unique:!1}),s.createIndex("cadetId","cadetId",{unique:!1}),s.createIndex("weekAndCadet",["weekStartDate","cadetId"],{unique:!0})}n.objectStoreNames.contains(c.TRAINING_EVENTS)||n.createObjectStore(c.TRAINING_EVENTS,{keyPath:"id"}),n.objectStoreNames.contains(c.METADATA)||n.createObjectStore(c.METADATA,{keyPath:"key"})}}),this.initPromise)}async getCachedCadets(t){try{return await this.init(),this.db?new Promise((e,r)=>{const d=this.db.transaction([c.CADETS],"readonly").objectStore(c.CADETS).index("company").getAll(t);d.onsuccess=()=>{const i=d.result;e(i.length>0?i:null)},d.onerror=()=>{console.error("Error reading cached cadets:",d.error),e(null)}}):null}catch(e){return console.error("Cache error:",e),null}}async cacheCadets(t){try{if(await this.init(),!this.db)return;const r=this.db.transaction([c.CADETS],"readwrite").objectStore(c.CADETS),a=new Set(t.map(n=>n.company));await Promise.all(Array.from(a).map(n=>new Promise(s=>{const i=r.index("company").openKeyCursor(IDBKeyRange.only(n)),h=[];i.onsuccess=C=>{const A=C.target.result;A?(h.push(A.primaryKey),A.continue()):Promise.all(h.map(g=>new Promise(p=>{const w=r.delete(g);w.onsuccess=()=>p(),w.onerror=()=>p()}))).then(()=>s())},i.onerror=()=>s()}))),await Promise.all(t.map(n=>new Promise((s,d)=>{const i=r.put(n);i.onsuccess=()=>s(),i.onerror=()=>{console.error("Error caching cadet:",i.error),s()}}))),await this.updateMetadata("cadets",Date.now())}catch(e){console.error("Error caching cadets:",e)}}async getCachedAttendance(t){try{return await this.init(),this.db?new Promise(e=>{const s=this.db.transaction([c.ATTENDANCE],"readonly").objectStore(c.ATTENDANCE).index("weekStartDate").getAll(t);s.onsuccess=()=>{const d=s.result;if(d.length===0){e(null);return}const i=new Map;d.forEach(h=>{i.set(h.cadetId,h)}),e(i)},s.onerror=()=>{console.error("Error reading cached attendance:",s.error),e(null)}}):null}catch(e){return console.error("Cache error:",e),null}}async cacheAttendance(t,e){try{if(await this.init(),!this.db)return;const a=this.db.transaction([c.ATTENDANCE],"readwrite").objectStore(c.ATTENDANCE),s=a.index("weekStartDate").openKeyCursor(IDBKeyRange.only(e));s.onsuccess=d=>{const i=d.target.result;i?(a.delete(i.primaryKey),i.continue()):(t.forEach((h,C)=>{const A={...h,id:`${e}_${C}`,weekStartDate:e,cadetId:C};a.put(A)}),this.updateMetadata(`attendance_${e}`,Date.now()))}}catch(r){console.error("Error caching attendance:",r)}}async updateMetadata(t,e){try{if(await this.init(),!this.db)return;this.db.transaction([c.METADATA],"readwrite").objectStore(c.METADATA).put({key:t,lastUpdated:e,version:D})}catch(r){console.error("Error updating metadata:",r)}}async getCacheAge(t){try{return await this.init(),this.db?new Promise(e=>{const n=this.db.transaction([c.METADATA],"readonly").objectStore(c.METADATA).get(t);n.onsuccess=()=>{const s=n.result;e(s?Date.now()-s.lastUpdated:null)},n.onerror=()=>e(null)}):null}catch{return null}}async clearCache(){try{if(await this.init(),!this.db)return;const t=this.db.transaction([c.CADETS,c.ATTENDANCE,c.TRAINING_EVENTS,c.METADATA],"readwrite");await Promise.all([new Promise(e=>{t.objectStore(c.CADETS).clear().onsuccess=()=>e()}),new Promise(e=>{t.objectStore(c.ATTENDANCE).clear().onsuccess=()=>e()}),new Promise(e=>{t.objectStore(c.TRAINING_EVENTS).clear().onsuccess=()=>e()}),new Promise(e=>{t.objectStore(c.METADATA).clear().onsuccess=()=>e()})])}catch(t){console.error("Error clearing cache:",t)}}async isCacheStale(t,e=5*60*1e3){const r=await this.getCacheAge(t);return r===null?!0:r>e}}const f=new O,l="cadets",k=2*60*1e3;async function V(o){const t=o==="Master"?"cadets_all":`cadets_${o}`;if(!await f.isCacheStale(t,k)){const r=await f.getCachedCadets(o);if(r)return b(o).catch(a=>console.error("Background fetch error:",a)),r}return b(o)}async function b(o){let t;if(o==="Master"){const e=E(m(u,l));t=(await S(e)).docs.map(a=>({id:a.id,...a.data()}))}else{const e=E(m(u,l),y("company","==",o));t=(await S(e)).docs.map(a=>({id:a.id,...a.data()})).sort((a,n)=>{const s=a.lastName.localeCompare(n.lastName);return s!==0?s:a.firstName.localeCompare(n.firstName)})}return await f.cacheCadets(t),t}function L(o,t,e){let r;return o==="Master"?r=E(m(u,l)):r=E(m(u,l),y("company","==",o)),I(r,async a=>{const n=a.docs.map(s=>({id:s.id,...s.data()}));o!=="Master"&&n.sort((s,d)=>{const i=s.lastName.localeCompare(d.lastName);return i!==0?i:s.firstName.localeCompare(d.firstName)}),await f.cacheCadets(n),t(n)},a=>{console.error("Error in cadets subscription:",a),e&&e(a)})}async function $(o){const t=N(u,l,o),e=await P(t);return e.exists()?{id:e.id,...e.data()}:null}async function U(o){const t=Object.fromEntries(Object.entries(o).filter(([r,a])=>a!==void 0));return(await R(m(u,l),t)).id}async function F(o,t){const e=Object.fromEntries(Object.entries(t).filter(([a,n])=>n!==void 0)),r=N(u,l,o);await x(r,e)}async function H(o){const t=N(u,l,o);await M(t)}async function W(o){const t=E(m(u,l),y("militaryScienceLevel","==",o));return(await S(t)).docs.map(r=>({id:r.id,...r.data()})).sort((r,a)=>{const n=r.lastName.localeCompare(a.lastName);return n!==0?n:r.firstName.localeCompare(a.firstName)})}export{$ as a,U as b,W as c,H as d,f as e,V as g,L as s,F as u};
