import{r as m,j as e}from"./react-vendor-C8iBsMnn.js";import{d as h,i as A,g as C,r as P,s as $,l as R}from"./index-D3ls51t0.js";import{f as S,d as E,h as k,j as L,T as z}from"./firebase-vendor-u2jlvS72.js";import"./vendor-C6jWcdt9.js";const U=["cadets","attendance","ptPlans","trainingEvents","pushSubscriptions","notificationRequests"];async function B(){const a={version:"1.0",timestamp:new Date().toISOString(),collections:{}};for(const t of U)try{const c=(await S(E(h,t))).docs.map(r=>({id:r.id,...r.data()})).map(r=>{const d={id:r.id};for(const[i,l]of Object.entries(r))i!=="id"&&(l&&typeof l=="object"&&"toDate"in l?d[i]=l.toDate().toISOString():l&&typeof l=="object"&&l.constructor===Object?d[i]=y(l):d[i]=l);return d});a.collections[t]=c}catch(n){console.error(`Error exporting collection ${t}:`,n)}return a}function y(a){if(a&&typeof a=="object"){if("toDate"in a)return a.toDate().toISOString();if(Array.isArray(a))return a.map(t=>y(t));{const t={};for(const[n,o]of Object.entries(a))t[n]=y(o);return t}}return a}function M(a,t){const n=JSON.stringify(a,null,2),o=new Blob([n],{type:"application/json"}),c=URL.createObjectURL(o),r=document.createElement("a");r.href=c,r.download=t||`backup_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(c)}async function q(a,t=!1){if(!a.collections)throw new Error("Invalid backup file: missing collections");const n=k(h);let o=0;const c=500;for(const[r,d]of Object.entries(a.collections))if(!(!d||!Array.isArray(d))){if(t)try{const i=await S(E(h,r)),l=k(h);let u=0;i.docs.forEach(p=>{u<c&&(l.delete(p.ref),u++)}),u>0&&await l.commit()}catch(i){console.error(`Error deleting existing documents from ${r}:`,i)}for(const i of d){if(!i.id){console.warn(`Skipping document in ${r} without id:`,i);continue}const l=L(h,r,i.id),{id:u,...p}=i,b=x(p);n.set(l,b),o++,o>=c&&(await n.commit(),o=0)}}o>0&&await n.commit()}function x(a){if(a&&typeof a=="object"&&!Array.isArray(a)){const t={};for(const[n,o]of Object.entries(a))if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(o))try{const c=new Date(o);isNaN(c.getTime())?t[n]=o:t[n]=z.fromDate(c)}catch{t[n]=o}else Array.isArray(o)?t[n]=o.map(c=>x(c)):o&&typeof o=="object"?t[n]=x(o):t[n]=o;return t}else if(Array.isArray(a))return a.map(t=>x(t));return a}function F(a){return new Promise((t,n)=>{const o=new FileReader;o.onload=c=>{var r;try{const d=(r=c.target)==null?void 0:r.result,i=JSON.parse(d);if(!i.timestamp||!i.collections){n(new Error("Invalid backup file format"));return}t(i)}catch(d){n(new Error(`Failed to parse backup file: ${d instanceof Error?d.message:"Unknown error"}`))}},o.onerror=()=>{n(new Error("Failed to read backup file"))},o.readAsText(a)})}function W({onBack:a}){const[t,n]=m.useState(""),[o,c]=m.useState(!1),[r,d]=m.useState(!1),[i,l]=m.useState("default"),[u,p]=m.useState(!1),[b,w]=m.useState(!1),f=m.useRef(null);m.useEffect(()=>{d(A()),l(C())},[]);async function v(){if(!t.trim()){alert("Please enter a message to send.");return}c(!0);try{if(i!=="granted"&&r)try{await P(),l("granted")}catch(s){console.warn("Could not request notification permission:",s)}await $(t.trim()),alert("Notification sent successfully!"),n("")}catch(s){console.error("Error sending notification:",s),alert(`Error sending notification: ${s instanceof Error?s.message:"Unknown error"}`)}finally{c(!1)}}async function D(){p(!0);try{const s=await B(),N=new Date().toISOString().replace(/[:.]/g,"-").split("T")[0];M(s,`bulldog-co-manager-backup-${N}.json`),alert("Database exported successfully! The backup file has been downloaded.")}catch(s){console.error("Error exporting database:",s),alert(`Error exporting database: ${s instanceof Error?s.message:"Unknown error"}`)}finally{p(!1)}}async function I(){var j;if(!f.current)return;const s=(j=f.current.files)==null?void 0:j[0];if(!s){alert("Please select a backup file to import.");return}if(!window.confirm("WARNING: This will replace all existing data with the backup data. This action cannot be undone. Are you sure you want to continue?")){f.current&&(f.current.value="");return}w(!0);try{const g=await F(s);await q(g,!0),alert("Database imported successfully! The page will now reload to show the restored data."),window.location.reload()}catch(g){console.error("Error importing database:",g),alert(`Error importing database: ${g instanceof Error?g.message:"Unknown error"}`)}finally{w(!1),f.current&&(f.current.value="")}}function T(){var s;(s=f.current)==null||s.click()}function O(){window.confirm("Are you sure you want to log out?")&&(R(),window.location.reload())}return e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-safe-area-inset-bottom",children:[e.jsx("header",{className:"bg-white border-b border-gray-200 sticky top-0 z-10 safe-area-inset-top",children:e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Settings"}),e.jsx("button",{onClick:a,className:"text-sm text-blue-600 font-medium touch-manipulation min-h-[44px] min-w-[44px]",children:"Home"})]})}),e.jsxs("main",{className:"px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Database Management"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Export all database data to a JSON backup file. This includes cadets, attendance records, PT plans, training events, and notifications."}),e.jsx("button",{onClick:D,disabled:u,className:`w-full py-3 px-4 rounded-lg font-semibold text-white touch-manipulation min-h-[44px] ${u?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 active:bg-blue-800"}`,children:u?"Exporting...":"Export Database"})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Import a backup file to restore the database. This will replace all existing data with the backup data."}),e.jsx("input",{ref:f,type:"file",accept:".json",onChange:I,className:"hidden","aria-label":"Import database backup file",title:"Import database backup file"}),e.jsx("button",{onClick:T,disabled:b,className:`w-full py-3 px-4 rounded-lg font-semibold text-white touch-manipulation min-h-[44px] ${b?"bg-gray-400 cursor-not-allowed":"bg-orange-600 hover:bg-orange-700 active:bg-orange-800"}`,children:b?"Importing...":"Import Database"}),e.jsx("p",{className:"text-xs text-red-600 mt-2",children:"⚠️ Warning: Importing will replace all existing data. Make sure to export a backup first if you want to keep current data."})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Send Notification"}),e.jsxs("div",{className:"space-y-4",children:[!r&&e.jsx("p",{className:"text-sm text-yellow-600 bg-yellow-50 p-3 rounded-md",children:"Push notifications are not supported in this browser."}),r&&i==="denied"&&e.jsx("p",{className:"text-sm text-red-600 bg-red-50 p-3 rounded-md",children:"Notification permission has been denied. Please enable notifications in your browser settings."}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notificationMessage",className:"block text-sm font-medium text-gray-700 mb-2",children:"Message"}),e.jsx("textarea",{id:"notificationMessage",value:t,onChange:s=>n(s.target.value),placeholder:"Enter your notification message here...",rows:4,className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm resize-none",disabled:o})]}),e.jsx("button",{onClick:v,disabled:o||!t.trim(),className:`w-full py-3 px-4 rounded-lg font-semibold text-white touch-manipulation min-h-[44px] ${o||!t.trim()?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 active:bg-blue-800"}`,children:o?"Sending...":"Send Notification"}),e.jsx("p",{className:"text-xs text-gray-500",children:"This will send a push notification to all users who have enabled notifications."})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Account"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("button",{onClick:O,className:"w-full py-3 px-4 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 active:bg-red-800 touch-manipulation min-h-[44px]",children:"Log Out"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Log out of your account. You will need to sign in again to access the application."})]})]})]})]})}export{W as default};
