import{q as f,w as T,d as h,k as R,f as w,j as A,l as k,h as D,s as _}from"./firebase-vendor-u2jlvS72.js";import{d as y}from"./index-DKB6D4ej.js";import{e as b,g as I}from"./cadetService-BXy_--2f.js";const p="attendance",$=2*60*1e3;function M(s,t){return`${t}_${s}`}async function N(s,t){const u=M(s,t),c=A(y,p,u),e=await k(c);return e.exists()?e.data():{cadetId:s,ptMonday:null,ptTuesday:null,ptWednesday:null,ptThursday:null,ptFriday:null,labThursday:null,tacticsTuesday:null,weekStartDate:t}}async function P(s){const t=M(s.cadetId,s.weekStartDate),u=A(y,p,t);await _(u,{cadetId:s.cadetId,weekStartDate:s.weekStartDate,ptMonday:s.ptMonday??null,ptTuesday:s.ptTuesday??null,ptWednesday:s.ptWednesday??null,ptThursday:s.ptThursday??null,ptFriday:s.ptFriday??null,labThursday:s.labThursday??null,tacticsTuesday:s.tacticsTuesday??null},{merge:!0}),`${s.weekStartDate}`}async function H(s){if(s.length===0)return;const t=500;for(let u=0;u<s.length;u+=t){const c=D(y);s.slice(u,u+t).forEach(n=>{const a=M(n.cadetId,n.weekStartDate),l=A(y,p,a);c.set(l,{cadetId:n.cadetId,weekStartDate:n.weekStartDate,ptMonday:n.ptMonday??null,ptTuesday:n.ptTuesday??null,ptWednesday:n.ptWednesday??null,ptThursday:n.ptThursday??null,ptFriday:n.ptFriday??null,labThursday:n.labThursday??null,tacticsTuesday:n.tacticsTuesday??null},{merge:!0})}),await c.commit()}}async function v(s,t){const u=`attendance_${t}`;if(!await b.isCacheStale(u,$)){const e=await b.getCachedAttendance(t);if(e){const n=await I(s),a=new Set(n.map(d=>d.id)),l=new Map;return e.forEach((d,i)=>{a.has(i)&&l.set(i,d)}),q(l,n,t),E(s,t).catch(d=>console.error("Background fetch error:",d)),l}}return E(s,t)}async function E(s,t){const u=await I(s),c=new Map,e=new Set(u.map(d=>d.id)),n=f(h(y,p),T("weekStartDate","==",t));return(await w(n)).docs.map(d=>d.data()).forEach(d=>{e.has(d.cadetId)&&c.set(d.cadetId,d)}),q(c,u,t),await b.cacheAttendance(c,t),c}function q(s,t,u){t.forEach(c=>{if(!s.has(c.id))s.set(c.id,{cadetId:c.id,ptMonday:null,ptTuesday:null,ptWednesday:null,ptThursday:null,ptFriday:null,labThursday:null,tacticsTuesday:null,weekStartDate:u});else{const e=s.get(c.id);if(!("ptTuesday"in e)){const n=e;s.set(c.id,{cadetId:c.id,ptMonday:null,ptTuesday:n.tuesday??null,ptWednesday:n.wednesday??null,ptThursday:n.thursday??null,ptFriday:null,labThursday:null,tacticsTuesday:null,weekStartDate:u})}}})}function O(s,t,u,c){const e=f(h(y,p),T("weekStartDate","==",t));return R(e,async n=>{const a=n.docs.map(o=>o.data()),l=new Map,d=await I(s),i=new Set(d.map(o=>o.id));a.forEach(o=>{i.has(o.cadetId)&&l.set(o.cadetId,o)}),q(l,d,t),await b.cacheAttendance(l,t),u(l)},n=>{console.error("Error in attendance subscription:",n),c&&c(n)})}async function j(s,t){const u=f(h(y,p),T("cadetId","==",s)),c=await w(u);let e=0;return c.docs.forEach(n=>{const a=n.data();(t==="PT"||!t)&&(a.ptMonday==="unexcused"&&e++,a.ptTuesday==="unexcused"&&e++,a.ptWednesday==="unexcused"&&e++,a.ptThursday==="unexcused"&&e++,a.ptFriday==="unexcused"&&e++,a.tuesday==="unexcused"&&!a.ptTuesday&&e++,a.wednesday==="unexcused"&&!a.ptWednesday&&e++,a.thursday==="unexcused"&&!a.ptThursday&&!a.labThursday&&e++),(t==="Lab"||!t)&&a.labThursday==="unexcused"&&e++,(t==="Tactics"||!t)&&a.tacticsTuesday==="unexcused"&&e++}),e}async function z(s,t){const u=f(h(y,p),T("cadetId","==",s)),c=await w(u),e=[];return c.docs.forEach(n=>{const a=n.data(),l=a.weekStartDate;if(!l)return;const[d,i,o]=l.split("-").map(Number),S=new Date(d,i-1,o+1),C=new Date(d,i-1,o+2),g=new Date(d,i-1,o+3),r=x=>{const m=x.getFullYear(),W=String(x.getMonth()+1).padStart(2,"0"),F=String(x.getDate()).padStart(2,"0");return`${m}-${W}-${F}`};if(t==="PT"){const x=new Date(d,i-1,o),m=new Date(d,i-1,o+4);a.ptMonday==="unexcused"&&e.push(r(x)),a.ptTuesday==="unexcused"&&e.push(r(S)),a.ptWednesday==="unexcused"&&e.push(r(C)),a.ptThursday==="unexcused"&&e.push(r(g)),a.ptFriday==="unexcused"&&e.push(r(m)),a.tuesday==="unexcused"&&!a.ptTuesday&&e.push(r(S)),a.wednesday==="unexcused"&&!a.ptWednesday&&e.push(r(C)),a.thursday==="unexcused"&&!a.ptThursday&&!a.labThursday&&e.push(r(g))}else t==="Lab"?a.labThursday==="unexcused"&&e.push(r(g)):t==="Tactics"&&a.tacticsTuesday==="unexcused"&&e.push(r(S))}),e.sort((n,a)=>a.localeCompare(n))}async function G(s,t){const u=new Map;if(s.forEach(a=>u.set(a,0)),s.length===0)return u;const c=10,e=[];for(let a=0;a<s.length;a+=c){const l=s.slice(a,a+c),d=f(h(y,p),T("cadetId","in",l));e.push(w(d))}return(await Promise.all(e)).forEach(a=>{a.docs.forEach(l=>{const d=l.data(),i=u.get(d.cadetId)||0;let o=0;(t==="PT"||!t)&&(d.ptMonday==="unexcused"&&o++,d.ptTuesday==="unexcused"&&o++,d.ptWednesday==="unexcused"&&o++,d.ptThursday==="unexcused"&&o++,d.ptFriday==="unexcused"&&o++,d.tuesday==="unexcused"&&!d.ptTuesday&&o++,d.wednesday==="unexcused"&&!d.ptWednesday&&o++,d.thursday==="unexcused"&&!d.ptThursday&&!d.labThursday&&o++),(t==="Lab"||!t)&&d.labThursday==="unexcused"&&o++,(t==="Tactics"||!t)&&d.tacticsTuesday==="unexcused"&&o++,u.set(d.cadetId,i+o)})}),u}async function K(s){const t=new Map,u=f(h(y,p),T("weekStartDate","==",s));return(await w(u)).docs.forEach(e=>{const n=e.data();"ptTuesday"in n?t.set(n.cadetId,n):t.set(n.cadetId,{cadetId:n.cadetId,ptMonday:null,ptTuesday:n.tuesday??null,ptWednesday:n.wednesday??null,ptThursday:n.thursday??null,ptFriday:null,labThursday:null,tacticsTuesday:null,weekStartDate:n.weekStartDate})}),t}async function X(){const s=await w(h(y,p)),t=D(y);s.docs.forEach(u=>{t.update(u.ref,{ptMonday:null,ptTuesday:null,ptWednesday:null,ptThursday:null,ptFriday:null,labThursday:null,tacticsTuesday:null})}),await t.commit()}export{G as a,H as b,K as c,j as d,z as e,X as f,v as g,N as h,O as s,P as u};
